# 负载均衡原理

## 1、负载均衡 ip_hash

**ip_hash** ：可以保证用户访问可以请求到上游服务中的固定的服务器，前提是用户ip没有发生更改。

使用ip_hash的注意点：不能把后台服务器直接移除，只能标记**down**

参考配置：

```
upstream tomcats {
        ip_hash;
        server 192.168.1.173:8080;
        server 192.168.1.174:8080 down;
        server 192.168.1.175:8080;
}
```

说明：

1. ip_hash 的哈希算法只计算ip地址的前三段，例如：用户172.16.109.132访问服务器时哈希算法只计算172.16.109，所以IP地址前三段相同的用户会被指向同一个服务器。
2. 由于ip_hash算法会将同一个用户的请求指向同一个服务器，所以如果用户发起的大量破坏性的请求的话，可能造成一个服务器负载过重。
3. 如果要一处nginx中的服务器，标记为down，可以保留当前的用户ip的哈希算法。

参考文档：

http://nginx.org/en/docs/http/ngx_http_upstream_module.html#ip_hash

## 2、负载均衡 url_hash

**url_hash**： 是对url进行哈希处理，比如/user/login，哈希处理后指向一个服务器处理；

特别注意url后有没有“/"是不一样的，比如www.tomcats.com/user/login 和 www.tomcats.com/user/login/由于一个有"/"，一个没有，哈希处理后指向的服务器可能不一样。

## 3、负载均衡 least_conn

**least_conn**：nginx将新的服务器访问直接指向当前连接数最少的那个服务器。

参考配置：

```
upstream tomcats {
    # url hash
    hash $request_uri;
    # 最少连接数
    # least_conn

    server 192.168.1.173:8080;
    server 192.168.1.174:8080;
    server 192.168.1.175:8080;
}


server {
    listen 80;
    server_name www.tomcats.com;

    location / {
        proxy_pass  http://tomcats;
    }
}
```

