# 注册中心知多少

服务注册就是服务治理这台戏的开场和第一步。这一节，将向大家介绍注册中心的运作模式、任务，以及服务节点是如何找到注册中心的。

## 1、注册中心漫谈

服务注册是为了解决 Who are you 这个问题，即获取所有服务节点的身份信息和服务名称，从注册中心的角度来说我们有以下两种比较直观的解决方室：

- **三顾茅庐：**由注册中心主动访问网络节点中所有机器；
- **等待戈多：**注册中心坐等服务节点上门注册。

大家来思考个问题，为什么目前主流的注册中心都选择第二种方案，而不是第一种呢?

那我们先来看看三顾茅庐的方式有哪些弊端：

1. **模型复杂：**网络环境浩如烟海，轮询每个节点的做法通常是注册中心发局域网广播，客户端响应的方式，这种方式就像你对着全世界喊我爱你，顿时感到有种无力感。现实中对于跨局域网的分布式系统来说，响应模型更加复杂；
2. **网络消耗大：**整个网络环境里会掺杂大量非服务节点，这些节点无需对送达的广播请求做出响应，这种广播的模式无疑增加了网络通讯成本
3. **服务端压力增加：**不仅要求注册中心向网络中所有节点主动发送广播请求，还需要对客户端的应答做出响应，一个担子两头挑，考虑到注册中心的节点数远远少于服务节点，我们要尽可能地减轻服务中心承载的业务。

那么对于Eureka来说，他又会选择哪种服务注册方式呢?

## 2、等待戈多

等待戈多是爱尔兰现代主义剧作家 Samuel  Beckett 创作的荒诞派戏剧，整场戏只有两幕，两流浪汉驻足在同一树下做一件事 “等待戈多”，他们对戈多一无所知，戈多是谁? 戈多住在哪里? 戈多现在情况怎样? 这些问题都没有答案，只有在戈多到来之后才能一揭晓.

Eureka 的服务注册就采用了这样一种 “等待戈多”的注册模式。注册中心就像这棵老树下的流浪汉，我们的服务节点就像一个个的“戈多先生"。流浪汉不去搅扰其他的 “哥多"、“哥少"先生，只静静等待那些真正的”戈多”来到他们面前，听戈多讲述自己的故事。

要说这种模式带来的好处那是相当的多：

1. **省心：** 对于网络中其它非服务节点来说不会产生任何无效请求；
2. **省时：** 省去了广播环节的时间，使注册效率大大提高；
3. **省力：** 节省了大量网络请求的开销。

大家通过后面的学习会发现，不仅在服务注册方面，在其他服务治理的环节中，Spring Cloud对注册中心可谓是优待有加，只接受服务节点上门服务，绝不主动出门联系。

这便是 Spring Cloud 大道至简的智慧所在，任何复杂的问题到了这里，都会通过最简单、最经济的方式来解决。

## 3、注册中心的日常任务

当我期盼的戈多到来了以后，他会告诉关于他的三件事情：

1. 他会的技能（所提供的微服务是什么，比如“洗剪吹”）
2. 他住在哪里 （IP地址+端口）
3. 他的状态（通常注册完成时的服务状态就是UP）

在等待戈多的过程中，其实这两位流浪汉也没有那么闲，他在空余时间还是干了两件微小的事：

- **心跳检测和服务剔除：** 已经注册过的戈多们，会时不时来跟我打声招呼（心跳检测），如果隔段时间没见着他们了，我就只好从注册名单中把他们删除 (服务剔除) ；
- **注册信息同步：** 我们两个流浪汉分别接待不同的戈多，有的戈多在我这里注册，没有在他那里注册。我抽空就会把我这里的戈多名单和他做分享。

## 3、戈多报道指南

在茫茫世界中游荡的戈多，是如何找到流浪汉去报道的呢?当然是靠着我们开发人员作为上帝视角预先告诉了他们流浪汉的地址，这个地址包含了三个维度的信息，分别是Region, Zone和URL。

> Region代表地理上的分区，而Zone则是这分区下的机房，大多数情况下我们的配置中心只存在一个机房，这时配置URL就好了(比如 http://localhost:20000/eureka/ )，这是注册中心的IP地址，同时Eureka会为我们指定一个默认的Region和Zone。

某些情况下当开发人员主动指定了注册中心的Region和Zone，比如在多机房的网络环境中，我给上海机房的注册中心指定了 region=east china，zone=sh，这时候服务节点的配置文件就会有一些不同了。

知道了地址以后，戈多也要准备下见了面告诉流浪汉什么，那就是：

- 我会提供什么服务 spring.application.name=xiiianchui；
- 我住在哪里-物理地址如 localhost:10000；
- 还有很多絮絮叨叨的琐事，比如instanceld，leaselnfo以及等等

## 4、小结

在这节中，我们学习了以下内容：

1. Eureka的注册模式 (等待戈多)；
2. 服务节点注册信息包合的主要内容；
3. 注册中心的技能树(服务注册，心跳检测，服务剔除)。